#!/bin/bash

ORG=openbao
PKG=openbao
if [ ! -f $PKG.spec.in ]; then
    echo "$PKG.spec.in doesn't exist!" >&2
    exit 1
fi
# Check if someone accidentally modified $PKG.spec. This is tricky
# because git does not keep track of whether not a file is readonly.
# This script generates it read-only, so if it isn't writable then it
# is OK.  Otherwise if it is more than 2 seconds newer than the .in 
# most likely it was edited after git checkout.
if [ -w $PKG.spec ]; then
    INTIME="$(stat -c '%Y' $PKG.spec.in)"
    OUTTIME="$(stat -c '%Y' $PKG.spec)"
    if (( $OUTTIME >= $INTIME + 2 )); then
        echo "$PKG.spec is newer than $PKG.spec.in -- was it accidentally edited?" >&2
        exit 2
    fi
fi
VERSION="$(sed -n 's/^Version:[ \t]*//p' $PKG.spec.in|sed 's/~/-/')"
GOMOD=/tmp/go.mod.$$
trap "rm -f $GOMOD" 0
URL="https://raw.githubusercontent.com/$ORG/$PKG/refs/tags/v$VERSION/go.mod"
if ! curl -o $GOMOD -sSL -f -m 15 $URL; then
    echo "Couldn't download $GOMOD" >&2
    exit 3
fi
rm -f $PKG.spec
while IFS='' read -r LINE; do
    if [[ "$LINE" = *"bundled provides" ]]; then
        awk '{if (index($1, "/") != 0 && ($1 != "//")) {print "Provides: bundled(golang("$1")) = "$2}}' $GOMOD | sed -e 's/-/_/g' | sort | uniq
    elif [[ "$LINE" = "License:"* ]]; then
        DIST="$PKG-dist-$VERSION"
        DISTBALL="$DIST.tar.xz"
        if [ ! -f "$DISTBALL" ]; then
            echo "$DISTBALL not found!" >&2
            exit 4
        fi
        LDEP=LICENSE_DEPENDENCIES.md
        tar --xform "s,$DIST/,," -xf $DISTBALL $DIST/$LDEP
        if [ ! -f $LDEP ]; then
            echo "$LDEP not found in $DISTBALL!" >&2
            exit 4
        fi
        MAINLICENSE="$(echo $LINE|awk '{print $2}')"
        LICENSES="$(echo $MAINLICENSE $(sed -n "s/^\*\*.*License:\*\* //p" openbao-dist-2.3.2/$LDEP|sort -u|grep -v "^$MAINLICENSE$")|sed 's/ / and /g')"
        rm -f $LDEP
        echo "License: $LICENSES"
    elif [[ "$LINE" = *"@GOVERSION@"* ]]; then
        if [ -f goversion.patch ]; then
            GOVERSION="$(sed -n 's/^\+go //p' goversion.patch)"
        else
            URL="https://raw.githubusercontent.com/$ORG/$PKG/refs/tags/v$VERSION/.go-version"
            GOVERSION="$(curl -sSL -f -m 15 $URL)"
        fi
        echo "$LINE" | sed "s/@GOVERSION@/$GOVERSION/"
    else
        echo "$LINE"
    fi
done <$PKG.spec.in >$PKG.spec
chmod 444 $PKG.spec
